/*! Fabrik */

var FbVisTimeline=new Class({Implements:[Options],options:{dateFormat:"%c",orientation:"0",urlfilters:[]},initialize:function(json,options){this.json=eval(json),this.setOptions(options),this.resizeTimerID=null,this.tl=null;var dateFormat=this.options.dateFormat;Timeline.GregorianDateLabeller.prototype.labelPrecise=function(t){return new Date(t.getTime()+6e4*t.getTimezoneOffset()).format(dateFormat)},this.eventSource=new Timeline.DefaultEventSource;var theme=Timeline.ClassicTheme.create();theme.event.bubble.width=320,theme.event.bubble.height=520,theme.event.track.height=11.5,theme.event.track.gap=.1,theme.ether.backgroundColors=["#000000","red"],theme.ether.highlightColor="red",Timeline.setDefaultTheme(theme);for(var bandBase={trackGap:.2,width:"70%",intervalUnit:Timeline.DateTime.DAY,intervalPixels:50},bandTracks=[],b=0;b<json.bands.length;b++){var bandClone=Object.clone(bandBase);bandClone.width=json.bands[b].width,bandClone.intervalUnit=json.bands[b].intervalUnit,bandClone.overview=json.bands[b].overview,bandClone.eventSource=this.eventSource,bandClone.theme=theme,bandTracks.push(Timeline.createBandInfo(bandClone))}for(b=1;b<json.bands.length;b++)bandTracks[b].syncWith=0,bandTracks[b].highlight=!0;SimileAjax.History.enabled=!1,this.tl=Timeline.create(document.id("my-timeline"),bandTracks,this.options.orientation),this.start=0;var data={option:"com_fabrik",format:"raw",task:"ajax_getEvents",view:"visualization",visualizationid:this.options.id,currentList:this.options.currentList,setListRefFromRequest:1,listref:this.options.listRef};data=Object.merge(data,this.options.urlfilters),this.options.admin?data.task="visualization.ajax_getEvents":data.controller="visualization.timeline",this.start=0,this.counter=new Element("div.timelineTotals").inject(document.id("my-timeline"),"before"),this.counter.set("text","loading"),this.ajax=new Request.JSON({url:"index.php",data:data,onSuccess:function(t){this.start=this.start+this.options.step,this.start>=t.fabrik.total?this.counter.set("text","loaded "+t.fabrik.total):this.counter.set("text","loading "+this.start+" / "+t.fabrik.total),this.eventSource.loadJSON(t.timeline.events,""),0===t.fabrik.done.toInt()&&(this.ajax.options.data.start=t.fabrik.next,this.ajax.options.data.currentList=t.fabrik.currentList,this.ajax.send())}.bind(this),onFailure:function(t){alert(t.status+": "+t.statusText)}}),Fabrik.addEvent("fabrik.advancedSearch.submit",function(t){console.log("cancel ajax"),this.ajax.cancel()}.bind(this)),this.ajax.send(),window.addEvent("resize",function(){null===this.resizeTimerID&&(this.resizeTimerID=window.setTimeout(function(){this.resizeTimerID=null,this.tl.layout()}.bind(this),500))}.bind(this)),this.watchDatePicker()},watchDatePicker:function(){var t=document.id("timelineDatePicker");if("null"!==typeOf(t)){var e={eventName:"click",ifFormat:this.options.dateFormat,daFormat:this.options.dateFormat,singleClick:!0,align:"Br",range:[1900,2999],showsTime:!1,timeFormat:"24",electric:!0,step:2,cache:!1,showOthers:!1,advanced:!1},i=this.options.dateFormat;e.date=Date.parseDate(t.value||t.innerHTML,i),e.onClose=function(t){t.hide()},e.onSelect=function(){(this.cal.dateClicked||this.cal.hiliteToday)&&(this.cal.callCloseHandler(),t.value=this.cal.date.format(i),this.tl.getBand(0).setCenterVisibleDate(this.cal.date))}.bind(this),e.inputField=t,e.button=document.id("timelineDatePicker_cal_img"),e.align="Tl",e.singleClick=!0,this.cal=new Calendar(0,e.date,e.onSelect,e.onClose),this.cal.showsOtherMonths=e.showOthers,this.cal.yearStep=e.step,this.cal.setRange(e.range[0],e.range[1]),this.cal.params=e,this.cal.setDateFormat(i),this.cal.create(),this.cal.refresh(),this.cal.hide(),"null"!==typeOf(e.button)&&e.button.addEvent("click",function(t){this.cal.showAtElement(e.button),this.cal.show()}.bind(this)),t.addEvent("blur",function(t){this.updateFromField()}.bind(this)),t.addEvent("keyup",function(t){"enter"===t.key&&this.updateFromField()}.bind(this))}},updateFromField:function(){var t=document.id("timelineDatePicker").value;d=Date.parseDate(t,this.options.dateFormat),this.cal.date=d;var e=new Date(this.cal.date.getTime()-6e4*this.cal.date.getTimezoneOffset());this.tl.getBand(0).scrollToCenter(e)},submit:function(){}});